<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Music Catalog Manager - Setup</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="page">
    <h1>Music Catalog Manager</h1>
    <p class="muted">
      Configure your raw music directory and the catalog JSON file. This app runs locally.
    </p>

    <form method="post" action="/setup" class="card" id="setupForm">
      <label>
        RawMusicDirectory (root folder containing your audio files)
        <div class="row" style="gap:8px; align-items:center;">
          <input id="rawDirInput" type="text" name="raw_music_directory" placeholder="Click Browse… to select a folder" value="{{ raw_music_directory }}" required style="flex:1;" />
          <button type="button" id="browseRawBtn">Browse…</button>
        </div>
        <div class="muted tiny" style="margin-top:6px;">
          Uses a native OS folder dialog. (Runs on the same machine as the server.)
        </div>
      </label>

      <label>
        CatalogFile (JSON path; will be created if missing)
        <div class="row" style="gap:8px; align-items:center;">
          <input id="catalogInput" type="text" name="catalog_file" placeholder="Click Browse… to select or create a JSON file" value="{{ catalog_file }}" required style="flex:1;" />
          <button type="button" id="browseCatalogBtn">Browse…</button>
        </div>
        <div class="muted tiny" style="margin-top:6px;">
          Tip: choosing a new JSON file will auto-scan the directory and populate default metadata.
        </div>
      </label>

      <div class="row">
        <button type="submit">Save & Open Library</button>
      </div>

      <p class="muted" style="margin-top: 12px;">
        Tip: keep one shared catalog per studio, and separate per-project mappings elsewhere.
      </p>
    </form>
  </div>

  <script>
    async function postJSON(url) {
      const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
      if (!r.ok) {
        throw new Error(`${r.status} ${r.statusText}`);
      }
      return await r.json();
    }

    function wire() {
      const rawBtn = document.getElementById('browseRawBtn');
      const catBtn = document.getElementById('browseCatalogBtn');
      const rawInput = document.getElementById('rawDirInput');
      const catInput = document.getElementById('catalogInput');

      rawBtn.addEventListener('click', async () => {
        rawBtn.disabled = true;
        try {
          const data = await postJSON('/api/dialog/select_raw_dir');
          if (data && data.path) {
            rawInput.value = data.path;
          } else {
            alert('Native folder dialog is unavailable in this environment. You can still paste the path manually.');
          }
        } catch (e) {
          alert(`Failed to open folder dialog: ${e.message}`);
        } finally {
          rawBtn.disabled = false;
        }
      });

      catBtn.addEventListener('click', async () => {
        catBtn.disabled = true;
        try {
          const data = await postJSON('/api/dialog/select_catalog_json');
          if (data && data.path) {
            catInput.value = data.path;
          } else {
            alert('Native file dialog is unavailable in this environment. You can still paste the path manually.');
          }
        } catch (e) {
          alert(`Failed to open file dialog: ${e.message}`);
        } finally {
          catBtn.disabled = false;
        }
      });
    }

    wire();
  </script>
</body>
</html>
